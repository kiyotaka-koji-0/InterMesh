name: Build iOS App

on:   
  push:
    branches: 
      - main
  pull_request:
    branches:  
      - main

jobs:  
  build-ios: 
    name: Build iOS App
    runs-on: macos-latest

    steps: 
      - name:  Checkout Repository
        uses: actions/checkout@v3

      - name: Set up Go
        uses: actions/setup-go@v4
        with:
          go-version: 1.21
          check-latest: true

      - name: Install gomobile
        run: |
          go install golang.org/x/mobile/cmd/gomobile@latest
          gomobile init

      - name:  Verify Go Version
        run: go version

      - name: Cache Go Modules
        uses: actions/cache@v3
        with:  
          path:  ~/go/pkg/mod
          key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}
          restore-keys: |
            ${{ runner.os }}-go-

      - name: Build iOS Framework
        run: |
          mkdir -p mobile/output
          gomobile bind -target=ios -o mobile/output/Intermesh. xcframework ./mobile

      - name: Set up Xcode
        run: |
          sudo xcode-select -s /Applications/Xcode.app/Contents/Developer

      - name: Build iOS App
        working-directory: mobile/ios-app
        run: |
          xcodebuild -scheme InterMesh -sdk iphoneos -configuration Release archive -archivePath ./build/InterMesh. xcarchive

      - name:  Export IPA
        working-directory: mobile/ios-app
        run: |
          xcodebuild -exportArchive \
            -archivePath ./build/InterMesh.xcarchive \
            -exportOptionsPlist ExportOptions.plist \
            -exportPath ./build \
            -allowProvisioningUpdates

      - name: Upload IPA Artifact
        uses: actions/upload-artifact@v4
        with: 
          name: InterMesh. ipa
          path: mobile/ios-app/build/InterMesh.ipa
